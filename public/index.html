<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EMUDriverTraining — Markdown Viewer</title>
  <meta name="color-scheme" content="light dark" />
  <!-- 使用外部樣式（含樹狀縮排、連續直線、圓點與折疊） -->
  <link rel="stylesheet" href="/styles.css">
  <style>
    /* 針對圖片再加一點保護，確保不破壞縮排 */
    .section-body img{
      display:block;
      max-width:100%;
      height:auto;
      border-radius:8px;
      cursor: zoom-in; /* 可點擊放大 */
    }
    /* 圖片在清單內的間距更好看 */
    .section-body li img{ margin-top:.25rem; }
    /* 讓清單項目的標記在外側，避免與樹狀圓點打架 */
    .section-body ul{ list-style-position: outside; padding-left: 1.25rem; }

    /* ===== 圖片全螢幕（overlay） ===== */
    .img-overlay{
      position: fixed;
      inset: 0;
      display: none;            /* 以 open class 控制顯示 */
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,.75);
      z-index: 1000;
      cursor: zoom-out;         /* 再點一次縮回 */
    }
    .img-overlay.open{ display: flex; }
    .img-overlay__img{
      max-width: 95vw;
      max-height: 95vh;
      object-fit: contain;      /* 維持比例 */
      border-radius: 8px;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      background: #000;         /* 照片透明邊時更好看 */
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- 依你的需求持續隱藏頁首與標題列 -->
    <header class="hdr" style="display:none">
      <div class="brand">EMUDriverTraining</div>
      <div class="muted">Markdown Viewer（基礎版）</div>
    </header>

    <article class="card">
      <div class="titlebar" style="display:none">
        <h1 id="docTitle">Loading…</h1>
        <div class="meta" id="docMeta">—</div>
      </div>
      <div class="content">
        <div class="md-root" id="mdRoot"></div>
      </div>
    </article>
  </div>

  <!-- 放大用的 overlay（預先放在 DOM，透過 class 切換） -->
  <div class="img-overlay" id="imgOverlay" aria-hidden="true">
    <img class="img-overlay__img" id="imgOverlayImg" alt="">
  </div>

  <script src="/lib/markdown-it.min.js"></script>
  <script>
  (function(){
    const MD_SRC  = '/content/index.md';
    const root    = document.getElementById('mdRoot');

    window.addEventListener('DOMContentLoaded', init);

    async function init(){
      if(typeof window.markdownit !== 'function'){
        return showError('找不到 markdown-it（/lib/markdown-it.min.js）。');
      }
      const md = window.markdownit({ html:false, linkify:true, typographer:true });

      try{
        const res  = await fetch(MD_SRC, { cache:'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status+' '+res.statusText);
        const text = await res.text();
        const { body } = parseFrontmatter(text);

        // 渲染 Markdown
        root.innerHTML = md.render(body);

        // 修正 Markdown 中的相對圖片路徑 -> 指向 /content/images/*
        rewriteRelativeImages(root);

        // 自動折疊（H2~H5），預設全部收合
        autoMakeCollapsible(root, { minLevel:2, maxLevel:5, defaultCollapsed:true });

        // 啟用圖片點擊放大/還原
        enableImageFullscreen(root);
      }catch(err){
        showError('載入 Markdown 失敗：' + String(err));
        console.error(err);
      }
    }

    /* 將 ./images/* 或 images/* 改寫到 /content/images/* */
    function rewriteRelativeImages(container){
      const imgs = container.querySelectorAll('img');
      imgs.forEach(img=>{
        const src = img.getAttribute('src') || '';
        if (/^\/content\//i.test(src)) return;
        if (/^\.?\/?images\//i.test(src)) {
          const clean = src.replace(/^\.\//, '').replace(/^\/?images\//i, 'images/');
          img.setAttribute('src', '/content/' + clean);
        }
      });
    }

    /* 圖片全螢幕切換 */
    function enableImageFullscreen(container){
      const overlay   = document.getElementById('imgOverlay');
      const overlayImg= document.getElementById('imgOverlayImg');

      function openOverlay(img){
        overlayImg.src = img.currentSrc || img.src;
        overlayImg.alt = img.alt || '';
        overlay.classList.add('open');
        overlay.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden'; // 防捲動
      }
      function closeOverlay(){
        overlay.classList.remove('open');
        overlay.setAttribute('aria-hidden', 'true');
        overlayImg.src = '';
        document.body.style.overflow = '';
      }

      // 點擊任何內容區的圖片 => 放大
      container.addEventListener('click', (e)=>{
        const img = e.target.closest('img');
        if(!img) return;
        openOverlay(img);
      });

      // 點 overlay 任意處 => 關閉
      overlay.addEventListener('click', closeOverlay);

      // 按 ESC 也可關閉
      window.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape' && overlay.classList.contains('open')){
          closeOverlay();
        }
      });
    }

    /* 自動折疊 + 設定縮排深度 */
    function autoMakeCollapsible(container, {minLevel=2, maxLevel=5, defaultCollapsed=false}={}){
      const allHeads = Array.from(container.querySelectorAll('h2,h3,h4,h5,h6'));
      const headings = allHeads.filter(h => levelOf(h) >= minLevel && levelOf(h) <= maxLevel);

      for(let i = headings.length - 1; i >= 0; i--){
        const h = headings[i];
        if (h.parentElement && h.parentElement.classList.contains('section')) continue;

        const curLv  = levelOf(h);
        const depth  = Math.max(0, curLv - minLevel); // H2=0, H3=1, ...
        const bodyFrag = document.createDocumentFragment();
        let n = h.nextSibling;
        let hasChildHeading = false;

        while(n){
          const isEl = n.nodeType === 1;

          if (isEl && isHeadingEl(n)) {
            const lv = levelOf(n);
            if (lv <= curLv) break;
            if (lv > curLv) hasChildHeading = true;
          }
          if (isEl && n.classList.contains('section')) {
            const first = n.firstElementChild;
            if (first && isHeadingEl(first)) {
              const lv = levelOf(first);
              if (lv <= curLv) break;
              if (lv > curLv) hasChildHeading = true;
            }
          }

          const next = n.nextSibling;
          bodyFrag.appendChild(n);
          n = next;
        }

        // 建立容器並設定深度
        const wrap = document.createElement('div');
        wrap.className = 'section';
        wrap.style.setProperty('--depth', depth);
        h.parentNode.insertBefore(wrap, h);
        wrap.appendChild(h);

        // 內容區
        if(hasChildHeading || bodyFrag.childNodes.length){
          const body = document.createElement('div');
          body.className = 'section-body';
          body.appendChild(bodyFrag);
          wrap.appendChild(body);

          const key = 'fold:' + curLv + ':' + normalizeText(h.textContent);
          const saved = loadState(key);
          const startCollapsed = (saved != null) ? saved : !!defaultCollapsed;
          if(startCollapsed) body.classList.add('collapsed');

          // 折疊按鈕
          const btn = document.createElement('button');
          btn.className = 'section-toggle';
          setToggleVisual(btn, body.classList.contains('collapsed'));
          btn.addEventListener('click', ()=>{
            const isNowCollapsed = !body.classList.contains('collapsed');
            body.classList.toggle('collapsed');
            setToggleVisual(btn, !isNowCollapsed);
            saveState(key, body.classList.contains('collapsed'));
          });
          // 放在標題最前面
          h.insertBefore(btn, h.firstChild);
        }
      }
    }

    function setToggleVisual(btn, collapsed){
      btn.textContent = collapsed ? '▶' : '▼';
      btn.setAttribute('aria-expanded', String(!collapsed));
      btn.title = collapsed ? '展開' : '收合';
    }
    function isHeadingEl(el){ return !!el && el.tagName && /^H[2-6]$/.test(el.tagName); }
    function levelOf(hEl){ return parseInt(hEl.tagName.slice(1),10); }
    function normalizeText(s){ return (s||'').replace(/\s+/g,'').trim(); }

    /* Frontmatter 解析 */
    function parseFrontmatter(src){
      if(src.charCodeAt(0) === 0xFEFF) src = src.slice(1);
      const m = src.match(/^---\s*[\r\n]([\s\S]*?)\r?\n---\s*[\r\n]([\s\S]*)$/);
      if(m) return { meta: yamlToJSON(m[1]), body: m[2] };
      return { meta:{}, body: src };
    }
    function yamlToJSON(yaml){
      const out = {};
      yaml.split(/\r?\n/).forEach(line=>{
        if(!line.trim() || line.trim().startsWith('#')) return;
        const i = line.indexOf(':'); if(i<1) return;
        const k = line.slice(0,i).trim();
        let v = line.slice(i+1).trim();
        if((v.startsWith('"') && v.endsWith('"'))||(v.startsWith("'") && v.endsWith("'"))) v=v.slice(1,-1);
        out[k]=v;
      });
      return out;
    }

    /* 狀態保存 */
    function saveState(key, val){ try{ localStorage.setItem(key, JSON.stringify(!!val)); }catch(e){} }
    function loadState(key){
      try{
        const v = localStorage.getItem(key);
        return v==null ? null : JSON.parse(v);
      }catch(e){ return null; }
    }

    function showError(msg){
      root.innerHTML = '<pre style="white-space:pre-wrap;background:#0001;padding:12px;border-radius:8px">'+msg+'</pre>';
    }
  })();
  </script>
</body>
</html>
