<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EMUDriverTraining â€” Markdown Viewer</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="stylesheet" href="/styles.css">
  <style>
    :root{
      /* æ¸…å–®å­—ç´šï¼ˆä¾› .section æ¨™é¡Œèˆ‡ä¸€èˆ¬ li ä½¿ç”¨ï¼‰ */
      --h-sub-font-size: 18px;
      --h-sub-line-height: 1.65;
      --h-sub-font-weight: 600;
    }

    /* å…§æ–‡åœ–ç‰‡ä¿è­·ï¼Œä¸ç ´å£ç¸®æ’ */
    .section-body img{
      display:block;
      max-width:100%;
      height:auto;
      border-radius:8px;
      cursor: zoom-in;
      touch-action: manipulation;
    }
    .section-body li img{ margin-top:.25rem; }

    /* åªåŒ…å«ä¸€å¼µåœ–ç‰‡çš„æ¸…å–®é …ç›®ï¼šå»åœ“é»ä¸¦å›é€€ä¸€éšï¼ˆå…¼å®¹èˆŠç€è¦½å™¨é  classï¼‰ */
    .section-body li:has(> img:only-child),
    .section-body li:has(> p:only-child > img:only-child){
      list-style: none;
      padding-left: 0;
      margin-left: calc(-1 * var(--indent));
    }
    .section-body li.li-image-only{
      list-style: none;
      padding-left: 0;
      margin-left: calc(-1 * var(--indent));
    }

    /* è®“æ–‡å­—å‹æ¸…å–®å­—ç´š = å‰¯æ¨™é¡Œ */
    .section-body li.li-as-heading{
      font-size: var(--h-sub-font-size);
      line-height: var(--h-sub-line-height);
      font-weight: var(--h-sub-font-weight);
    }

    /* ===== åœ–ç‰‡å…¨è¢å¹•ï¼ˆoverlayï¼‰ ===== */
    .img-overlay{
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: rgba(0,0,0,.85); z-index: 1000;
      cursor: zoom-out; overflow: hidden;
      -webkit-user-select: none; user-select: none; touch-action: none;
    }
    .img-overlay.open{ display: flex; }
    .img-overlay__viewport{
      position: relative; width: 95vw; height: 95vh;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden; background: #000; border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
    }
    .img-overlay__img{
      max-width: 100%; max-height: 100%; object-fit: contain;
      will-change: transform; cursor: zoom-in;
    }
    .img-overlay__img.grabbable { cursor: grab; }
    .img-overlay__img.grabbing  { cursor: grabbing; }

    /* section æ¨™é¡Œåˆ—ï¼ˆå«å½ headingï¼‰ */
    .section > [role="heading"]{
      display:flex; align-items:center; column-gap:.5rem;
      margin: 0.35rem 0; min-height: 28px;
      font-size: var(--h-sub-font-size);
      line-height: var(--h-sub-line-height);
      font-weight: var(--h-sub-font-weight);
      cursor: pointer;                 /* é»æ¨™é¡Œå³å¯å±•é–‹/æ”¶åˆ */
      user-select: none;
    }
    .section > [role="heading"]::before{
      content:""; flex:none; display:inline-block;
      width: var(--bullet-size); height: var(--bullet-size);
      border-radius: 50%;
      box-sizing: border-box;           /* ä¿æŒå¤–å¾‘ä¸€è‡´ */
      margin-left: calc(-1 * (var(--gutter) - var(--bullet-size)) + var(--bullet-nudge-x));
      margin-right: .35rem;
      /* é è¨­å¯¦å¿ƒï¼›æœ‰å­ç¯€é»æ™‚æœƒè¢«è¦†è“‹ç‚ºç©ºå¿ƒ */
      background: var(--bullet);
      border: 2px solid transparent;
    }
    /* æœ‰å­å±¤ç´šï¼ç©ºå¿ƒåœ“é»ï¼ˆå¤–å¾‘èˆ‡å¯¦å¿ƒç›¸åŒï¼‰ */
    .section.has-children > [role="heading"]::before{
      background: transparent;
      border-color: var(--bullet);
    }

    .section.no-rail::before{ display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hdr" style="display:none">
      <div class="brand">EMUDriverTraining</div>
      <div class="muted">Markdown Viewerï¼ˆæ¸…å–®æ¨¹ç‹€ç‰ˆï¼‰</div>
    </header>

    <article class="card">
      <div class="titlebar" style="display:none">
        <h1 id="docTitle">Loadingâ€¦</h1>
        <div class="meta" id="docMeta">â€”</div>
      </div>
      <div class="content">
        <div class="md-root" id="mdRoot"></div>
      </div>
    </article>
  </div>

  <!-- æ”¾å¤§ç”¨ overlay -->
  <div class="img-overlay" id="imgOverlay" aria-hidden="true">
    <div class="img-overlay__viewport" id="imgViewport">
      <img class="img-overlay__img" id="imgOverlayImg" alt="">
    </div>
  </div>

  <script src="/lib/markdown-it.min.js"></script>
  <script>
  (function(){
    const MD_SRC  = '/content/index.md';
    const root    = document.getElementById('mdRoot');

    window.addEventListener('DOMContentLoaded', init);

    async function init(){
      if(typeof window.markdownit !== 'function'){
        return showError('æ‰¾ä¸åˆ° markdown-itï¼ˆ/lib/markdown-it.min.jsï¼‰ã€‚');
      }
      const md = window.markdownit({ html:false, linkify:true, typographer:true });

      try{
        const res  = await fetch(MD_SRC, { cache:'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status+' '+res.statusText);
        const text = await res.text();
        const { body } = parseFrontmatter(text);

        // 1) æ¸²æŸ“ Markdown
        root.innerHTML = md.render(body);

        // 2) å°‡ ./images/* æˆ– images/* æ”¹å¯«åˆ° /content/images/*
        rewriteRelativeImages(root);

        // 3) å°‡ <ul>/<ol> çš„ <li> è½‰æˆ .sectionï¼ˆå–æ¶ˆæŒ‰éˆ•ï¼›é»æ¨™é¡Œå±•é–‹ï¼‰
        listsToSections(root, { defaultCollapsed: true });

        // 4) æ¨™è¨˜ã€Œåªå«ä¸€å¼µåœ–ç‰‡ã€èˆ‡ã€Œä¸€èˆ¬æ–‡å­—å‹ã€çš„ liï¼ˆèˆŠç€è¦½å™¨ fallbackï¼‰
        markImageOnlyLis(root);
        tagHeadingSizedLis(root);

        // 5) åˆæ¬¡æ›´æ–°ã€Œæ˜¯å¦ç•«å°è»Œã€ï¼ˆåŒå±¤åªæœ‰ä¸€å€‹å­ç¯€é» â†’ ä¸ç•«ï¼‰
        updateRailVisibility(root);

        // 6) å•Ÿç”¨åœ–ç‰‡é»æ“Šå…¨è¢å¹• + æ»¾è¼ªç¸®æ”¾/æ‹–æ›³
        enableImageFullscreen(root);
      }catch(err){
        showError('è¼‰å…¥ Markdown å¤±æ•—ï¼š' + String(err));
        console.error(err);
      }
    }

    /* è¨ˆç®— li çš„çœŸå¯¦å±¤ç´šæ·±åº¦ */
    function listDepth(li){
      let depth = 0;
      let current = li.parentElement;
      while(current && current !== root){
        if(current.tagName === 'UL' || current.tagName === 'OL'){
          depth++;
        }
        current = current.parentElement;
      }
      return Math.max(0, depth - 1);
    }

    /* æŠŠ <li> è½‰æˆ .section */
    function listsToSections(container, { defaultCollapsed=false }={}){
      const allLis = Array.from(container.querySelectorAll('li')).reverse();
      allLis.forEach(li=>{
        const depth = listDepth(li);
        const wrap  = document.createElement('div');
        wrap.className = 'section';
        wrap.style.setProperty('--depth', depth);

        const heading = document.createElement('div');
        heading.setAttribute('role','heading');
        heading.setAttribute('aria-level', String(Math.min(2 + depth, 7)));
        heading.setAttribute('tabindex', '0'); // å¯éµç›¤æ“ä½œ

        const body = document.createElement('div');
        body.className = 'section-body';

        // æ‹†åˆ†æ¨™é¡Œèˆ‡å…§å®¹
        const fragHead = document.createDocumentFragment();
        const fragBody = document.createDocumentFragment();
        let n = li.firstChild, metList = false;
        while(n){
          const next = n.nextSibling;
          if(!metList && n.nodeType===1 && (n.tagName==='UL' || n.tagName==='OL')){
            metList = true;
          }
          (metList ? fragBody : fragHead).appendChild(n);
          n = next;
        }
        if(!fragHead.childNodes.length){
          const span = document.createElement('span');
          span.textContent = '(ç©ºç™½ç¯€é»)';
          fragHead.appendChild(span);
        }
        heading.appendChild(fragHead);
        body.appendChild(fragBody);

        // é è¨­æ”¶åˆï¼ˆå¯è¨˜æ†¶ï¼‰
        const key = 'fold:li:' + normalizeText(heading.textContent);
        const saved = loadState(key);
        const startCollapsed = (saved != null) ? saved : !!defaultCollapsed;
        if(startCollapsed) body.classList.add('collapsed');
        heading.setAttribute('aria-expanded', String(!startCollapsed));

        // å…ˆæŠŠ wrap æ”¾å¥½ï¼Œå†åµæ¸¬æœ‰ç„¡å­ç¯€é»ï¼ˆå­å±¤çš„ .section å·²å…ˆè½‰å¥½ï¼Œå› ç‚ºæˆ‘å€‘ reverseï¼‰
        wrap.appendChild(heading);
        wrap.appendChild(body);
        li.replaceWith(wrap);

        /* ğŸ”§ ä¿®æ­£ï¼šåµæ¸¬ä»»æ„å¾Œä»£ .sectionï¼ˆè€Œéåƒ…ç›´å±¬ï¼‰
           ä»¥æ­£ç¢ºåˆ¤æ–·æœ‰ç„¡å­å±¤ç´š â†’ æ§åˆ¶ç©ºå¿ƒ/å¯¦å¿ƒåœ“é» */
        const hasChildren = !!body.querySelector('.section');
        wrap.classList.toggle('has-children', hasChildren);
        wrap.classList.toggle('is-leaf', !hasChildren);

        // é»æ“Šæ¨™é¡Œåˆ—å³å¯å±•é–‹/æ”¶åˆ
        const toggle = ()=>{
          const nextCollapsed = !body.classList.contains('collapsed');
          body.classList.toggle('collapsed', nextCollapsed);
          heading.setAttribute('aria-expanded', String(!nextCollapsed));
          saveState(key, nextCollapsed);
          updateRailVisibility(container);
        };
        heading.addEventListener('click', toggle);
        heading.addEventListener('keydown', (e)=>{
          if(e.key === 'Enter' || e.key === ' '){
            e.preventDefault(); toggle();
          }
          if(e.key === 'ArrowRight' && body.classList.contains('collapsed')){
            e.preventDefault(); toggle();
          }
          if(e.key === 'ArrowLeft' && !body.classList.contains('collapsed')){
            e.preventDefault(); toggle();
          }
        });
      });

      container.querySelectorAll('ul,ol').forEach(list=>{
        list.classList.add('list-host');
      });
    }

    /* å°‡ ./images/* æˆ– images/* æ”¹å¯«åˆ° /content/images/* */
    function rewriteRelativeImages(container){
      const imgs = container.querySelectorAll('img');
      imgs.forEach(img=>{
        const src = img.getAttribute('src') || '';
        if (/^\/content\//i.test(src)) return;
        if (/^\.?\/?images\//i.test(src)) {
          const clean = src.replace(/^\.\//, '').replace(/^\/?images\//i, 'images/');
          img.setAttribute('src', '/content/' + clean);
        }
      });
    }

    /* æ¨™è¨˜åªæœ‰ä¸€å¼µåœ–ç‰‡çš„ liï¼ˆå°é½Š :has() çš„æ¢ä»¶ï¼‰ */
    function markImageOnlyLis(container){
      const lis = container.querySelectorAll('li');
      lis.forEach(li=>{
        const kids = Array.from(li.childNodes).filter(n => !(n.nodeType===3 && !n.textContent.trim()));
        let onlyImg = false;
        if(kids.length === 1 && kids[0].nodeType === 1){
          const el = kids[0];
          if(el.tagName === 'IMG'){
            onlyImg = true;
          }else if(el.tagName === 'P'){
            const pKids = Array.from(el.childNodes).filter(n => !(n.nodeType===3 && !n.textContent.trim()));
            if(pKids.length === 1 && pKids[0].nodeType === 1 && pKids[0].tagName === 'IMG'){
              onlyImg = true;
            }
          }
        }
        if(onlyImg) li.classList.add('li-image-only');
      });
    }

    /* æ¨™è¨˜ç´”æ–‡å­—å‹æ¸…å–®é …ç›®ï¼ˆç”¨ä¾†å°‡å­—ç´šå°é½Š headingï¼‰ */
    function tagHeadingSizedLis(container){
      const lis = container.querySelectorAll('li');
      lis.forEach(li=>{
        const kids = Array.from(li.childNodes).filter(n => {
          if(n.nodeType === 3) return !!n.textContent.trim();
          return n.nodeType === 1;
        });
        const hasNoNestedList = !li.querySelector('ul,ol');
        const hasNoImg = !li.querySelector('img');
        if(kids.length === 1 && hasNoNestedList && hasNoImg){
          const el = kids[0];
          if(el.nodeType === 3 || (el.nodeType === 1 && !['IMG','UL','OL'].includes(el.tagName))){
            li.classList.add('li-as-heading');
          }
        }
      });
    }

    /* æ›´æ–°å°è»Œå¯è¦‹æ€§ï¼šè‹¥åŒå±¤åªæœ‰å–®ä¸€å­é …ï¼Œå°±ä¸éœ€è¦ç•«å°è»Œ */
    function updateRailVisibility(container){
      const sections = container.querySelectorAll('.section');
      sections.forEach(s=>{
        const body = s.querySelector('.section-body');
        if(!body) return;
        const childSections = Array.from(body.children).filter(c => c.classList.contains('section'));
        const shouldHide = (childSections.length === 1);
        childSections.forEach(child=>{
          child.classList.toggle('no-rail', shouldHide);
        });
      });
    }

    /* åœ–ç‰‡å…¨è¢å¹•ï¼ˆç¸®æ”¾+æ‹–æ›³ï¼‰ */
    function enableImageFullscreen(container){
      const overlay = document.getElementById('imgOverlay');
      const viewport = document.getElementById('imgViewport');
      const overlayImg = document.getElementById('imgOverlayImg');
      if(!overlay || !viewport || !overlayImg) return;

      let scale = 1, tx = 0, ty = 0, dragging = false, lastX = 0, lastY = 0, baseRect = null;
      const MIN_SCALE = 1, MAX_SCALE = 5;
      function applyTransform(){
        overlayImg.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
      }
      function calcBaseRect(){
        return overlayImg.getBoundingClientRect();
      }
      function resetTransform(){
        scale = 1; tx = 0; ty = 0; applyTransform();
        overlayImg.classList.remove('grabbable','grabbing'); overlay.style.cursor = 'zoom-out';
      }
      function clampPan(){
        const vpW = viewport.clientWidth, vpH = viewport.clientHeight;
        const imgW = baseRect ? baseRect.width  : overlayImg.getBoundingClientRect().width / scale;
        const imgH = baseRect ? baseRect.height : overlayImg.getBoundingClientRect().height / scale;
        const scaledW = imgW * scale, scaledH = imgH * scale;
        const maxX = Math.max(0, (scaledW - vpW) / 2), maxY = Math.max(0, (scaledH - vpH) / 2);
        tx = maxX===0 ? 0 : Math.max(-maxX, Math.min(maxX, tx));
        ty = maxY===0 ? 0 : Math.max(-maxY, Math.min(maxY, ty));
      }
      function zoomAt(clientX, clientY, deltaY){
        const zoomFactor = Math.exp(-deltaY * 0.002);
        const newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, scale * zoomFactor));
        if(newScale === scale) return;
        const vpRect = viewport.getBoundingClientRect();
        const offsetX = clientX - (vpRect.left + vpRect.width/2);
        const offsetY = clientY - (vpRect.top  + vpRect.height/2);
        const imgToCursorX = offsetX - tx, imgToCursorY = offsetY - ty;
        const ratio = newScale / scale;
        tx = offsetX - imgToCursorX * ratio;
        ty = offsetY - imgToCursorY * ratio;
        scale = newScale; clampPan(); applyTransform();
        if(scale > 1){ overlayImg.classList.add('grabbable'); overlay.style.cursor = 'default'; }
        else { overlayImg.classList.remove('grabbable','grabbing'); overlay.style.cursor = 'zoom-out'; }
      }
      function openOverlay(img){
        overlayImg.src = img.currentSrc || img.src; overlayImg.alt = img.alt || '';
        overlay.classList.add('open'); overlay.setAttribute('aria-hidden', 'false'); document.body.style.overflow = 'hidden';
        if(overlayImg.complete){ baseRect = calcBaseRect(); } else { overlayImg.onload = ()=>{ baseRect = calcBaseRect(); }; }
        resetTransform();
      }
      function closeOverlay(){
        overlay.classList.remove('open'); overlay.setAttribute('aria-hidden', 'true');
        overlayImg.src = ''; document.body.style.overflow = '';
      }
      container.addEventListener('click', (e)=>{ const img = e.target.closest('img'); if(img) openOverlay(img); });
      overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeOverlay(); });
      window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && overlay.classList.contains('open')) closeOverlay(); });
      overlay.addEventListener('wheel', (e)=>{ e.preventDefault(); const dy = e.deltaY * (e.ctrlKey ? 0.5 : 1); zoomAt(e.clientX, e.clientY, dy); }, { passive: false });
      overlayImg.addEventListener('dblclick', (e)=>{ e.preventDefault(); if(scale === 1){ const fakeDelta = Math.log(2/scale)/(-0.002); zoomAt(e.clientX, e.clientY, fakeDelta); } else { resetTransform(); } });
      overlayImg.addEventListener('pointerdown', (e)=>{ if(scale <= 1) return; e.preventDefault(); dragging = true; lastX = e.clientX; lastY = e.clientY; overlayImg.setPointerCapture(e.pointerId); overlayImg.classList.add('grabbing'); });
      overlayImg.addEventListener('pointermove', (e)=>{ if(!dragging) return; const dx = e.clientX - lastX, dy = e.clientY - lastY; lastX = e.clientX; lastY = e.clientY; tx += dx; ty += dy; clampPan(); applyTransform(); });
      const endDrag = (e)=>{ if(!dragging) return; dragging = false; overlayImg.classList.remove('grabbing'); try{ overlayImg.releasePointerCapture(e.pointerId); }catch(_){} };
      overlayImg.addEventListener('pointerup', endDrag); overlayImg.addEventListener('pointercancel', endDrag);
    }

    /* Frontmatter è§£æ */
    function parseFrontmatter(src){
      if(src.charCodeAt(0) === 0xFEFF) src = src.slice(1);
      const m = src.match(/^---\s*[\r\n]([\s\S]*?)\r?\n---\s*[\r\n]([\s\S]*)$/);
      if(m) return { meta: yamlToJSON(m[1]), body: m[2] };
      return { meta:{}, body: src };
    }
    function yamlToJSON(yaml){
      const out = {};
      yaml.split(/\r?\n/).forEach(line=>{
        if(!line.trim() || line.trim().startsWith('#')) return;
        const i = line.indexOf(':'); if(i<1) return;
        const k = line.slice(0,i).trim();
        let v = line.slice(i+1).trim();
        if((v.startsWith('"') && v.endsWith('"'))||(v.startsWith("'") && v.endsWith("'"))) v=v.slice(1,-1);
        out[k]=v;
      });
      return out;
    }

    /* ç‹€æ…‹ä¿å­˜ */
    function saveState(key, val){ try{ localStorage.setItem(key, JSON.stringify(!!val)); }catch(e){} }
    function loadState(key){
      try{
        const v = localStorage.getItem(key);
        return v==null ? null : JSON.parse(v);
      }catch(e){ return null; }
    }
    function normalizeText(s){ return (s||'').replace(/\s+/g,'').trim(); }

    function showError(msg){
      root.innerHTML = '<pre style="white-space:pre-wrap;background:#0001;padding:12px;border-radius:8px">'+msg+'</pre>';
    }
  })();
  </script>
</body>
</html>
